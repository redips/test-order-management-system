{% extends 'base.html.twig' %}

{% block title %}Orders - Order Management System{% endblock %}

{% block body %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-list-ul me-2"></i>Order List
                </h5>
                <a href="{{ path('app_order_create') }}" class="btn btn-primary">
                    <i class="bi bi-plus-circle me-1"></i>Create Order
                </a>
            </div>
            <div class="card-body">
                <!-- Filters -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <label class="form-label">Order Number</label>
                        <input type="text" class="form-control" id="filterOrderNumber" placeholder="Search...">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Customer Code</label>
                        <input type="text" class="form-control" id="filterCustomerCode" placeholder="Search...">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Customer Name</label>
                        <input type="text" class="form-control" id="filterCustomerName" placeholder="Search...">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Date From</label>
                        <input type="date" class="form-control" id="filterDateFrom">
                    </div>
                </div>
                <div class="row mb-4">
                    <div class="col-md-3">
                        <label class="form-label">Date To</label>
                        <input type="date" class="form-control" id="filterDateTo">
                    </div>
                    <div class="col-md-9 d-flex align-items-end">
                        <button class="btn btn-primary me-2" onclick="applyFilters()">
                            <i class="bi bi-search me-1"></i>Search
                        </button>
                        <button class="btn btn-secondary" onclick="clearFilters()">
                            <i class="bi bi-x-circle me-1"></i>Clear
                        </button>
                    </div>
                </div>

                <!-- Alert for messages -->
                <div id="alertContainer"></div>

                <!-- Orders Table -->
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Order Number</th>
                                <th>Customer Code</th>
                                <th>Customer Name</th>
                                <th>Created At</th>
                                <th class="text-end">Total Amount</th>
                                <th class="text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="ordersTableBody">
                            <tr>
                                <td colspan="6" class="text-center">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascripts %}
<script>
    let currentFilters = {};

    async function loadOrders(filters = {}) {
        const tbody = document.getElementById('ordersTableBody');
        tbody.innerHTML = `
            <tr>
                <td colspan="6" class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </td>
            </tr>
        `;

        const queryParams = new URLSearchParams(filters).toString();
        const url = `/api/orders${queryParams ? '?' + queryParams : ''}`;

        try {
            const response = await fetch(url);
            const result = await response.json();

            if (result.success && result.data.length > 0) {
                tbody.innerHTML = result.data.map(order => `
                    <tr>
                        <td><strong>${escapeHtml(order.orderNumber)}</strong></td>
                        <td>${escapeHtml(order.customerCode)}</td>
                        <td>${escapeHtml(order.customerName)}</td>
                        <td>${formatDate(order.createdAt)}</td>
                        <td class="text-end"><strong>â‚¬${parseFloat(order.totalAmount).toFixed(2)}</strong></td>
                        <td class="text-center">
                            <a href="/order/${order.id}" class="btn btn-sm btn-info me-1" title="View">
                                <i class="bi bi-eye"></i>
                            </a>
                            <a href="/order/${order.id}/edit" class="btn btn-sm btn-warning me-1" title="Edit">
                                <i class="bi bi-pencil"></i>
                            </a>
                            <button onclick="deleteOrder(${order.id})" class="btn btn-sm btn-danger" title="Delete">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');
            } else {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center text-muted">
                            <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                            No orders found
                        </td>
                    </tr>
                `;
            }
        } catch (error) {
            console.error('Error loading orders:', error);
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center text-danger">
                        Error loading orders. Please try again.
                    </td>
                </tr>
            `;
        }
    }

    function applyFilters() {
        currentFilters = {};
        
        const orderNumber = document.getElementById('filterOrderNumber').value.trim();
        const customerCode = document.getElementById('filterCustomerCode').value.trim();
        const customerName = document.getElementById('filterCustomerName').value.trim();
        const dateFrom = document.getElementById('filterDateFrom').value;
        const dateTo = document.getElementById('filterDateTo').value;

        if (orderNumber) currentFilters.orderNumber = orderNumber;
        if (customerCode) currentFilters.customerCode = customerCode;
        if (customerName) currentFilters.customerName = customerName;
        if (dateFrom) currentFilters.dateFrom = dateFrom;
        if (dateTo) currentFilters.dateTo = dateTo;

        loadOrders(currentFilters);
    }

    function clearFilters() {
        document.getElementById('filterOrderNumber').value = '';
        document.getElementById('filterCustomerCode').value = '';
        document.getElementById('filterCustomerName').value = '';
        document.getElementById('filterDateFrom').value = '';
        document.getElementById('filterDateTo').value = '';
        currentFilters = {};
        loadOrders();
    }

    async function deleteOrder(orderId) {
        if (!confirm('Are you sure you want to delete this order?')) {
            return;
        }

        try {
            const response = await fetch(`/api/orders/${orderId}`, {
                method: 'DELETE'
            });

            const result = await response.json();

            if (result.success) {
                showAlert('Order deleted successfully', 'success');
                loadOrders(currentFilters);
            } else {
                showAlert(result.message || 'Error deleting order', 'danger');
            }
        } catch (error) {
            console.error('Error deleting order:', error);
            showAlert('Error deleting order', 'danger');
        }
    }

    function showAlert(message, type = 'info') {
        const alertContainer = document.getElementById('alertContainer');
        const alert = document.createElement('div');
        alert.className = `alert alert-${type} alert-dismissible fade show`;
        alert.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        alertContainer.appendChild(alert);

        setTimeout(() => {
            alert.remove();
        }, 5000);
    }

    function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleString('en-GB', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
        });
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Load orders on page load
    document.addEventListener('DOMContentLoaded', () => {
        loadOrders();
    });
</script>
{% endblock %}
